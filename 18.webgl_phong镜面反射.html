<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<script type="module">
  import { WebGL, Object3D, Camera } from "./js/index.js";
  import { mulMat4 } from "./js/Math.js";
  const webgl = new WebGL("canvas");


  // 创建立方体的着色器程序
  const program = webgl.useProgram(
          `#version 300 es

           uniform mat4 u_MVP;  // 投影视图模型矩阵
           uniform mat4 u_MV;  // 视图模型矩阵
           layout(location = 0) in vec4 a_Position;
           layout(location = 1) in vec3 a_Normal;

            out vec3 v_PosW; // 世界空间顶点位置
            out vec3 v_Normal; // 世界空间法线

           void main() {
             gl_Position = u_MVP * a_Position;
             v_PosW = (u_MV * a_Position).xyz;
             v_Normal = normalize(mat3(u_MV) * a_Normal); // 法线变
           }
          `,
          `#version 300 es
           precision mediump float;

           uniform vec3  u_LightPosW;   // 世界空间光源位置
           uniform vec3  u_ViewPosW;    // 世界空间摄像机位置
           uniform float u_Shininess;   // 光泽度（越大光斑越小）


           in vec3 v_PosW; // 世界空间顶点位置
           in vec3 v_Normal; // 世界空间法线

           uniform vec4 u_Color;              // 材质颜色
           out vec4 fragColor;

           void main() {

             vec3 N = normalize(v_Normal);
             vec3 L = normalize(u_LightPosW - v_PosW);   // 光方向
             vec3 V = normalize(u_ViewPosW  - v_PosW);   // 视线方向
             vec3 R = reflect(-L, N);                    // 完美反射方向

              float lambert = max(dot(N, L), 0.0);
              vec3  diff    = u_Color.rgb * lambert;

              float specAngle = max(dot(V, R), 0.0);
              vec3  spec      = pow(specAngle, u_Shininess) * vec3(1.0); // 白光高光

              fragColor = vec4(diff + spec, u_Color.a);
           }
      `
  );


  // 创建立方体的顶点位置
  webgl.VertexBufferData(webgl.gl.ARRAY_BUFFER,
          new Float32Array([
            /*  底面四边形  (normal 0,-1,0)  */
            -0.5,-0.5,-0.5,  0,-1,0,  // 0
            0.5,-0.5,-0.5,  0,-1,0,  // 1
            0.5,-0.5, 0.5,  0,-1,0,  // 2
            -0.5,-0.5, 0.5,  0,-1,0,  // 3

            /*  顶面四边形  (normal 0,1,0)  */
            -0.5, 0.5, 0.5,  0,1,0,   // 4
            0.5, 0.5, 0.5,  0,1,0,   // 5
            0.5, 0.5,-0.5,  0,1,0,   // 6
            -0.5, 0.5,-0.5,  0,1,0,   // 7

            /*  前面四边形  (normal 0,0,1)  */
            -0.5,-0.5, 0.5,  0,0,1,   // 8
            0.5,-0.5, 0.5,  0,0,1,   // 9
            0.5, 0.5, 0.5,  0,0,1,   //10
            -0.5, 0.5, 0.5,  0,0,1,   //11

            /*  后面四边形  (normal 0,0,-1) */
            0.5,-0.5,-0.5,  0,0,-1,  //12
            -0.5,-0.5,-0.5,  0,0,-1,  //13
            -0.5, 0.5,-0.5,  0,0,-1,  //14
            0.5, 0.5,-0.5,  0,0,-1,  //15

            /*  右面四边形  (normal 1,0,0)  */
            0.5,-0.5,-0.5,  1,0,0,   //16
            0.5,-0.5, 0.5,  1,0,0,   //17
            0.5, 0.5, 0.5,  1,0,0,   //18
            0.5, 0.5,-0.5,  1,0,0,   //19

            /*  左面四边形  (normal -1,0,0) */
            -0.5,-0.5, 0.5, -1,0,0,  //20
            -0.5,-0.5,-0.5, -1,0,0,  //21
            -0.5, 0.5,-0.5, -1,0,0,  //22
            -0.5, 0.5, 0.5, -1,0,0,  //23
          ]), webgl.gl.STATIC_DRAW, [
            {location: 0, size: 3}, // 位置
            {location: 1, size: 3}  // 法线
          ])

  webgl.IndexBufferData(webgl.gl.ELEMENT_ARRAY_BUFFER,
          new Uint16Array([
            0, 1, 2,   0, 2, 3,    // 底
            4, 5, 6,   4, 6, 7,    // 顶
            8, 9,10,   8,10,11,    // 前
            12,13,14,  12,14,15,    // 后
            16,17,18,  16,18,19,    // 右
            20,21,22,  20,22,23,    // 左
          ]), webgl.gl.STATIC_DRAW)

  // 使用Object3D创建立方体对象
  const cube = new Object3D();
  cube.setRotation(20, 40, 0);

  // 创建透视摄像机
  const camera = new Camera(webgl.canvas.width, webgl.canvas.height);
  camera.EyePosition = [0, 0, 6]; // 设置相机位置
  camera.TargetObject = [0, 0, 0]; // 明确设置目标点

  // 手动更新视图矩阵
  camera._updateViewMatrix();

  // 计算mvp矩阵
  const M = cube.ModelMatrix;
  const V = camera.ViewMatrix;
  const P = camera.ProjectionMatrix;

  const vp = new Float32Array(16);
  const mv = new Float32Array(16);
  const mvp = new Float32Array(16);

  mulMat4(P, V, vp);
  mulMat4(vp, M, mvp);
  mulMat4(V, M, mv);

  webgl.setUniformMatrix4(program, "u_MV", mv);
  webgl.setUniformMatrix4(program, "u_MVP", mvp);
  webgl.setUniform4f(program, "u_Color", 1.0, 0.5, 0.0, 1.0); // 设置材质颜色
  webgl.setUniform1f(program, "u_Shininess", 32.0);
  webgl.setUniform3f(program, "u_ViewPosW", 0,  0, 5);
  webgl.setUniform3f(program, "u_LightPosW",  0, 10, 0); // 设置光源位置


  // 绘制
  webgl.gl.clearColor(0.0, 0.0, 0.0, 0.0);
  webgl.gl.enable(webgl.gl.DEPTH_TEST);
  webgl.gl.clear(
          webgl.gl.COLOR_BUFFER_BIT | webgl.gl.DEPTH_BUFFER_BIT
  );
  webgl.gl.drawElements(
          webgl.gl.TRIANGLES,
          36,
          webgl.gl.UNSIGNED_SHORT,
          0
  );
</script>
</body>
</html>